#!/usr/bin/env python3
import subprocess
import json
import sys

def clean_line(line):
    """
    Clean a line by stripping whitespace, removing any trailing commas,
    and stripping surrounding quotes.
    """
    line = line.strip()
    if line.endswith(','):
        line = line[:-1].strip()
    if line.startswith('"') and line.endswith('"'):
        line = line[1:-1].strip()
    return line

def get_all_config_details():
    try:
        result = subprocess.run(
            ["gphoto2", "--list-all-config"],
            capture_output=True,
            text=True,
            check=True
        )
    except subprocess.CalledProcessError as e:
        print("Error running gphoto2 --list-all-config:", e.stderr, file=sys.stderr)
        sys.exit(1)
    
    all_configs = []
    current_block = []
    for raw_line in result.stdout.splitlines():
        line = clean_line(raw_line)
        if not line:
            continue
        
        if line == "END":
            if current_block:
                # The first line in the block is the configuration key.
                config_key = current_block[0]
                label = None
                current_val = None
                for block_line in current_block[1:]:
                    if block_line.startswith("Label:"):
                        label = block_line[len("Label:"):].strip()
                    elif block_line.startswith("Current:"):
                        current_val = block_line[len("Current:"):].strip()
                all_configs.append({
                    "key": config_key,
                    "label": label,
                    "current": current_val
                })
                current_block = []
        else:
            current_block.append(line)
    
    # Process any remaining block if it wasn't terminated with "END"
    if current_block:
        config_key = current_block[0]
        label = None
        current_val = None
        for block_line in current_block[1:]:
            if block_line.startswith("Label:"):
                label = block_line[len("Label:"):].strip()
            elif block_line.startswith("Current:"):
                current_val = block_line[len("Current:"):].strip()
        all_configs.append({
            "key": config_key,
            "label": label,
            "current": current_val
        })
    
    return all_configs

def write_json(data, filename="gphoto2_config.json"):
    try:
        with open(filename, "w") as f:
            json.dump(data, f, indent=4)
        print(f"Configuration details successfully written to {filename}")
    except IOError as e:
        print("Error writing to file:", e, file=sys.stderr)
        sys.exit(1)

def main():
    configs = get_all_config_details()
    write_json(configs)

if __name__ == "__main__":
    main()

